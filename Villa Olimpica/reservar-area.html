<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reservar Instalación — Villa Olímpica</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: "Inter", sans-serif;
      background: url('https://images.unsplash.com/photo-1518609878373-06d740f60d8b?auto=format&fit=crop&w=2000&q=80')
                  center/cover fixed no-repeat;
      backdrop-filter: blur(6px);
      min-height: 100vh;
    }

    .overlay {
      background: rgba(0,0,0,0.75);
      min-height: 100vh;
      padding: 30px 0;
    }

    .card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 16px;
      padding: 22px;
      backdrop-filter: blur(6px);
    }

    .btn-main {
      background: linear-gradient(90deg, #1d4ed8, #2563eb);
      color: white;
    }
  </style>
</head>

<body class="text-white">

<div class="overlay">

  <div class="max-w-3xl mx-auto card shadow-xl">

    <h1 id="tituloInst" class="text-3xl font-extrabold mb-1"></h1>
    <p id="descInst" class="text-gray-300 mb-6"></p>

    <hr class="border-white/20 mb-6">

    <!-- FORMULARIO -->
    <form id="formReserva" class="space-y-4">

      <h2 class="text-xl font-bold">Datos del Reservante</h2>

      <div>
        <label class="text-sm">Nombre completo</label>
        <input required id="nombre" class="w-full p-2 bg-white/10 rounded outline-none">
      </div>

      <div>
        <label class="text-sm">Teléfono</label>
        <input required id="telefono" class="w-full p-2 bg-white/10 rounded outline-none">
      </div>

      <div>
        <label class="text-sm">Institución (opcional)</label>
        <input id="institucion" class="w-full p-2 bg-white/10 rounded outline-none">
      </div>

      <hr class="border-white/20">

      <h2 class="text-xl font-bold">Detalles de la Reservación</h2>

      <div>
        <label class="text-sm">Fecha</label>
        <input required type="date" id="fecha" class="w-full p-2 bg-white/10 rounded outline-none">
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="text-sm">Hora inicio</label>
          <input required type="time" id="horaInicio" class="w-full p-2 bg-white/10 rounded outline-none">
        </div>
        <div>
          <label class="text-sm">Hora fin</label>
          <input required type="time" id="horaFin" class="w-full p-2 bg-white/10 rounded outline-none">
        </div>
      </div>

      <div>
        <label class="text-sm">Motivo / Actividad</label>
        <textarea required id="motivo" class="w-full p-2 bg-white/10 rounded outline-none"></textarea>
      </div>

      <hr class="border-white/20">

      <!-- CAMPOS DINÁMICOS -->
      <div id="camposDinamicos" class="space-y-4"></div>

      <button class="btn-main w-full py-3 mt-4 rounded-lg font-bold text-lg">
        Confirmar Reserva
      </button>

      <p id="msg" class="text-center mt-3 text-sm"></p>

    </form>

  </div>
</div>

<!-- Supabase + Lógica -->
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js";

  const supabase = createClient(
    "https://wzovzfrrgknhvcozektc.supabase.co",
    "YOUR_PUBLIC_ANON_KEY"
  );

  // Obtener instalación desde la URL
  const params = new URLSearchParams(window.location.search);
  const instCodigo = params.get("instalacion");

  // Diccionario instalaciones
  const instalaciones = {
    palacio_deportes: {
      nombre: "Palacio de los Deportes",
      desc: "Pabellón principal para baloncesto y deportes de cancha.",
      campos: `
        <div>
          <label class="text-sm">Tipo de uso</label>
          <select id="tipoUso" class="w-full p-2 bg-white/10 rounded">
            <option>Entrenamiento</option>
            <option>Partido</option>
            <option>Torneo</option>
          </select>
        </div>
        <div>
          <label class="text-sm">Cantidad de jugadores</label>
          <input id="jugadores" type="number" min="1" class="w-full p-2 bg-white/10 rounded">
        </div>`
    },

    pabellon_gimnasia: {
      nombre: "Pabellón de Gimnasia",
      desc: "Área para taekwondo, halterofilia y artes marciales.",
      campos: `
        <div>
          <label class="text-sm">Disciplina</label>
          <select id="disciplina" class="w-full p-2 bg-white/10 rounded">
            <option>Taekwondo</option>
            <option>Pesas</option>
            <option>Karate</option>
            <option>Lucha</option>
          </select>
        </div>`
    },

    piscina_olimpica: {
      nombre: "Piscina Olímpica",
      desc: "Piscina actualmente en proceso de reacondicionamiento.",
      campos: `
        <div>
          <label class="text-sm">Uso previsto</label>
          <select id="usoPiscina" class="w-full p-2 bg-white/10 rounded">
            <option>Entrenamiento</option>
            <option>Recreación</option>
          </select>
        </div>`
    },

    campo_pista: {
      nombre: "Campo y Pista",
      desc: "Área para atletismo y ejercicios.",
      campos: `
        <div>
          <label class="text-sm">Tipo de entrenamiento</label>
          <input id="tipoEntreno" class="w-full p-2 bg-white/10 rounded">
        </div>`
    },

    canchas_aire_libre: {
      nombre: "Canchas al Aire Libre",
      desc: "Basketball, voleibol y tenis.",
      campos: `
        <div>
          <label class="text-sm">Deporte</label>
          <select id="deporte" class="w-full p-2 bg-white/10 rounded">
            <option>Basketball</option>
            <option>Voleibol</option>
            <option>Tenis</option>
          </select>
        </div>`
    }
  };

  // Cargar datos
  if (!instalaciones[instCodigo]) {
    document.body.innerHTML = "<h1>Error: Instalación no válida</h1>";
  } else {
    const inst = instalaciones[instCodigo];
    tituloInst.textContent = inst.nombre;
    descInst.textContent = inst.desc;
    camposDinamicos.innerHTML = inst.campos;
  }

  fecha.min = new Date().toISOString().split("T")[0];

  // GUARDAR RESERVA
  formReserva.addEventListener("submit", async (e) => {
    e.preventDefault();

    const msg = document.getElementById("msg");

    if (horaFin.value <= horaInicio.value) {
      msg.textContent = "La hora de fin debe ser mayor.";
      msg.className = "text-red-400";
      return;
    }

    // Obtener instalación de Supabase
    const { data: inst } = await supabase
      .from("instalaciones")
      .select("id")
      .eq("codigo", instCodigo)
      .single();

    // Insertar reserva
    const { error } = await supabase.from("reservas").insert([{
      instalacion_id: inst.id,
      nombre_reservante: nombre.value,
      telefono: telefono.value,
      institucion: institucion.value,
      fecha: fecha.value,
      hora_inicio: horaInicio.value,
      hora_fin: horaFin.value,
      descripcion: motivo.value,
      estado: "pendiente"
    }]);

    if (error) {
      msg.textContent = "Error al registrar reserva.";
      msg.className = "text-red-400";
      console.log(error);
      return;
    }

    msg.textContent = "Reserva realizada correctamente.";
    msg.className = "text-green-400";

    setTimeout(() => window.location.href = "inicio.html", 1400);
  });

</script>

</body>
</html>
