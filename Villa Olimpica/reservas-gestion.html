<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Gesti√≥n de Reservas ‚Äî Villa Ol√≠mpica</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #0f172a; 
            --card-bg: rgba(30, 41, 59, 0.7); 
            --primary: #3b82f6; 
            --accent: #22d3ee; 
            --text-light: #f8fafc; 
            --text-muted: #94a3b8; 
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(59, 130, 246, 0.15) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(34, 211, 238, 0.1) 0%, transparent 20%);
            color: var(--text-light);
            margin: 0;
            min-height: 100vh;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        .glass-panel {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 24px;
            transition: all 0.3s ease;
        }
        .text-glow { text-shadow: 0 0 20px rgba(34, 211, 238, 0.3); }
        .muted { color: var(--text-muted); font-size:.9rem; }
        .small-muted { color: var(--text-muted); font-size: 0.8rem; }
        .badge { 
            padding: 4px 12px; 
            border-radius: 999px; 
            font-size: 11px;
            font-weight: 600;
        }

        /* Modal - FIX AGRESIVO */
        #modalOverlay{
          position:fixed; inset:0;
          background:rgba(0,0,0,0.7); 
          backdrop-filter: blur(5px);
          display:flex; align-items:center; justify-content:center;
          z-index:50;
        }
        .modal-force-hidden {
             display: none !important; /* Fuerza el ocultamiento inicial */
        }
        .modal-content{
          background:var(--bg-dark); 
          padding:24px;
          border-radius:20px; 
          width:90%; 
          max-width:480px;
          color: var(--text-light);
          border: 1px solid var(--accent); 
          box-shadow: 0 0 20px rgba(34, 211, 238, 0.3);
        }
        .modal-btn-close {
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-muted);
        }
        /* [Otras clases de estilos omitidas por brevedad, pero incluidas en el c√≥digo anterior] */

    </style>
</head>

<body>
<div class="min-h-screen">
    <header class="bg-[#0f172a]/80 backdrop-blur-sm border-b border-white/5 sticky top-0 z-10">
        <div class="main-container flex justify-between items-center py-4">
            <div class="flex items-center gap-4">
                <a href="menu-gestion.html" class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600 to-cyan-500 flex items-center justify-center text-white font-black text-xl shadow-lg shadow-blue-500/20">
                    V
                </a>
                <div class="text-xl font-bold text-white tracking-tight hidden sm:block">
                    Gesti√≥n de Reservas
                </div>
            </div>
            
            <nav class="flex items-center gap-3 text-sm font-medium">
                <a class="px-3 py-1.5 rounded-full text-slate-400 hover:bg-white/5 transition-colors" href="menu-gestion.html">Atras</a>
            </nav>
        </div>
    </header>


    <main class="main-container">

        <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-8">
            <div>
                <h1 class="text-4xl font-extrabold text-white tracking-tight text-glow mb-1">
                    üóìÔ∏è Administrar Solicitudes
                </h1>
                <p class="small-muted" id="userInfo">Cargando usuario‚Ä¶</p>
            </div>
            <div class="flex items-center gap-3 mt-4 md:mt-0">
                <select id="filterEstado" class="filter-select">
                    <option value="">Todos los estados</option>
                    <option value="pendiente">Pendiente</option>
                    <option value="aprobada">Aprobada</option>
                    <option value="rechazada">Rechazada</option>
                </select>
                <button id="btnRefresh" class="btn-primary-action px-4 py-2 text-sm font-semibold">Actualizar Lista</button>
            </div>
        </div>

        <section class="glass-panel p-6">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="font-bold text-xl text-white">Listado de Reservas</h2>
                    <p class="muted text-sm">Visualiza y gestiona las reservas realizadas.</p>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full text-sm text-slate-200">
                    <thead class="table-header-dark text-xs uppercase">
                        <tr>
                            <th class="py-2 pr-4 text-left w-1/12">Reserva</th>
                            <th class="py-2 pr-4 text-left w-2/12">Instalaci√≥n</th>
                            <th class="py-2 pr-4 text-left w-2/12">Solicitante</th>
                            <th class="py-2 pr-4 text-left w-2/12">Duraci√≥n</th>
                            <th class="py-2 pr-4 text-left w-1/12">Estado</th>
                            <th class="py-2 pr-4 text-center w-4/12">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="reservasBody" class="divide-y divide-white/5">
                        <tr class="table-row-dark">
                            <td colspan="6" class="py-6 small-muted text-center">Cargando reservas...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

</div>

<div id="modalOverlay" class="fixed inset-0 hidden items-center justify-center z-50 modal-force-hidden">
    <div class="modal-content">
        <div class="flex justify-between items-start">
            <div>
                <h3 id="modalTitle" class="text-2xl font-bold text-white mb-1">Detalle de reserva</h3>
                <p id="modalSub" class="small-muted">Informaci√≥n completa</p>
            </div>
            <button onclick="cerrarModal()" class="text-sm px-4 py-1.5 rounded-lg modal-btn-close">Cerrar</button>
        </div>

        <div id="modalBody" class="mt-6 text-sm space-y-3 p-4 rounded-lg border border-white/10 bg-white/5"></div>

        <div class="mt-6 flex gap-3">
            <button id="modalAprobar" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-colors">Aprobar</button>
            <button id="modalRechazar" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors">Rechazar</button>
        </div>
    </div>
</div>

<script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";

    // Supabase: usa tu proyecto URL y la anon public key
    const SUPABASE_URL = "https://wzovzfrrgknhvcozektc.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6b3Z6ZnJyZ2tuaHZjb3pla3RjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MzYyMTAsImV4cCI6MjA3ODExMjIxMH0.zhbQqSEje7RGhZpJlUEaGZ07nuCOCamQI7S97rf-Tfo";

    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // DOM
    const reservasBody = document.getElementById("reservasBody");
    const btnRefresh = document.getElementById("btnRefresh");
    const filterEstado = document.getElementById("filterEstado");
    const userInfo = document.getElementById("userInfo");

    const modalOverlay = document.getElementById("modalOverlay");
    const modalBody = document.getElementById("modalBody");
    const modalTitle = document.getElementById("modalTitle");
    const modalSub = document.getElementById("modalSub");
    const modalAprobar = document.getElementById("modalAprobar");
    const modalRechazar = document.getElementById("modalRechazar");

    let currentModalId = null;
    let currentModalCorreo = null;

    // Helper: Formatear fecha/hora
    const formatDate = (date, time) => {
        const d = new Date(`${date}T${time}`);
        return d.toLocaleDateString('es-DO', { 
            day: '2-digit', month: '2-digit', year: 'numeric',
            hour: '2-digit', minute: '2-digit', hour12: true 
        }).replace(',', '');
    };

    // Cargar y mostrar usuario
    async function verificarAcceso() {
        try {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                userInfo.textContent = "Sesi√≥n no iniciada";
                return;
            }
            const { data: perfil } = await supabase
                .from("usuarios")
                .select("nombre, rol")
                .eq("email", user.email)
                .single();

            if (perfil && userInfo) {
                userInfo.innerHTML = `Administrador logueado: <span class="text-white font-semibold">${perfil.nombre}</span> ‚Ä¢ ${perfil.rol}`;
            }
        } catch (err) {
            console.error("verificarAcceso:", err);
        }
    }

    // Funci√≥n para cargar reservas con filtro
    async function cargarReservas() {
        reservasBody.innerHTML = `
            <tr class="table-row-dark"><td colspan="6" class="py-6 text-center muted">Cargando reservas...</td></tr>
        `;

        try {
            let query = supabase
                .from("reservas")
                .select("id, instalacion_id, nombre_completo, correo, telefono, institucion, fecha_inicio, fecha_fin, hora_inicio, hora_fin, descripcion, estado, created_at")
                .order("created_at", { ascending: false });

            const estadoFilter = filterEstado.value;
            if (estadoFilter) {
                query = query.eq("estado", estadoFilter);
            }

            const { data, error } = await query;
            if (error) throw error;

            if (!data || data.length === 0) {
                reservasBody.innerHTML = `
                    <tr class="table-row-dark"><td colspan="6" class="py-6 text-center muted">No hay reservas registradas.</td></tr>
                `;
                return;
            }
            
            // Renderizar la tabla
            reservasBody.innerHTML = data.map(r => {
                const colorClass = r.estado === "pendiente" ? "bg-amber-600/30 text-amber-300 border-amber-600" :
                                   r.estado === "aprobada"  ? "bg-green-600/30 text-green-300 border-green-600" :
                                                               "bg-red-600/30 text-red-300 border-red-600";
                
                const btnDisabledClass = r.estado !== 'pendiente' ? 'bg-slate-700/50 text-slate-500 cursor-not-allowed' : 'hover:bg-opacity-90';

                return `
                    <tr class="table-row-dark">
                        <td class="py-3 pr-4 align-top text-xs text-slate-400 font-mono">${r.id.substring(0, 8)}...</td>
                        <td class="py-3 pr-4 align-top font-semibold text-white">${r.instalacion_id}</td>
                        <td class="py-3 pr-4 align-top">
                            <div class="font-semibold text-white">${r.nombre_completo}</div>
                            <div class="small-muted">${r.correo}</div>
                        </td>
                        <td class="py-3 pr-4 align-top text-xs">
                            ${formatDate(r.fecha_inicio, r.hora_inicio)} <span class="text-slate-500">a</span>
                            ${formatDate(r.fecha_fin, r.hora_fin)}
                        </td>
                        <td class="py-3 pr-4 align-top"><span class="badge border ${colorClass}">${r.estado}</span></td>
                        <td class="py-3 pr-4 align-top text-center">
                            <div class="flex flex-col sm:flex-row gap-2 justify-center">
                                <button class="px-3 py-1 bg-cyan-600/20 text-cyan-300 rounded text-xs hover:bg-cyan-600/50 transition-colors" onclick="verMas('${r.id}')">Ver detalle</button>
                                <button class="px-3 py-1 bg-green-600 text-white rounded text-xs font-semibold ${btnDisabledClass}" 
                                        ${r.estado !== 'pendiente' ? 'disabled' : ''}
                                        onclick="cambiarEstado('${r.id}','aprobada','${r.correo}')">Aprobar</button>
                                <button class="px-3 py-1 bg-red-600 text-white rounded text-xs font-semibold ${btnDisabledClass}" 
                                        ${r.estado !== 'pendiente' ? 'disabled' : ''}
                                        onclick="cambiarEstado('${r.id}','rechazada','${r.correo}')">Rechazar</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join("");

        } catch (err) {
            console.error("cargarReservas:", err);
            reservasBody.innerHTML = `<tr><td colspan="6" class="py-6 text-center text-red-400">Error al cargar reservas.</td></tr>`;
        }
    }

    /* -------------------------------------
       GESTI√ìN DEL MODAL
    ------------------------------------- */

    // Funci√≥n global para cerrar el modal
    window.cerrarModal = function() {
        modalOverlay.classList.add('hidden');
        modalOverlay.classList.remove('flex');
        modalOverlay.classList.remove('modal-force-hidden'); 
        currentModalId = null;
        currentModalCorreo = null;
        modalBody.innerHTML = "";
    };

    // Ver m√°s: abrir modal con datos completos
    window.verMas = async function(id) {
        try {
            const { data, error } = await supabase
                .from("reservas")
                .select("*")
                .eq("id", id)
                .single();

            if (error) throw error;

            currentModalId = id;
            currentModalCorreo = data.correo;

            modalTitle.textContent = `Reserva para: ${data.instalacion_id}`;
            modalSub.textContent = `Solicitante: ${data.nombre_completo}`;

            const actionsActive = data.estado === 'pendiente';
            modalAprobar.disabled = !actionsActive;
            modalRechazar.disabled = !actionsActive;

            // Ajustar clases de los botones seg√∫n el estado
            modalAprobar.classList.toggle('bg-gray-500', !actionsActive);
            modalRechazar.classList.toggle('bg-gray-500', !actionsActive);
            modalAprobar.classList.toggle('bg-green-600', actionsActive);
            modalRechazar.classList.toggle('bg-red-600', actionsActive);

            modalBody.innerHTML = `
                <div class="grid grid-cols-2 gap-y-2 gap-x-4">
                    <div class="col-span-2 border-b border-white/10 pb-2 mb-2 font-bold text-base text-cyan-300">Datos del Solicitante</div>
                    <div><strong>Nombre:</strong> <span class="text-white">${data.nombre_completo}</span></div>
                    <div><strong>Correo:</strong> <span class="text-white">${data.correo}</span></div>
                    <div><strong>Tel√©fono:</strong> <span class="text-white">${data.telefono}</span></div>
                    <div class="col-span-2"><strong>Instituci√≥n:</strong> <span class="text-white">${data.institucion || 'Particular'}</span></div>

                    <div class="col-span-2 border-b border-white/10 pt-4 pb-2 mb-2 font-bold text-base text-cyan-300">Detalles de Uso</div>
                    <div><strong>Instalaci√≥n:</strong> <span class="text-white">${data.instalacion_id}</span></div>
                    <div><strong>Estado:</strong> <span class="font-bold text-white">${data.estado}</span></div>
                    <div class="col-span-2"><strong>Inicio:</strong> <span class="text-white">${formatDate(data.fecha_inicio, data.hora_inicio)}</span></div>
                    <div class="col-span-2"><strong>Fin:</strong> <span class="text-white">${formatDate(data.fecha_fin, data.hora_fin)}</span></div>
                    <div class="col-span-2 pt-4"><strong>Descripci√≥n:</strong> <p class="text-slate-300 mt-1">${data.descripcion || '‚Äî'}</p></div>
                </div>
            `;

            // mostrar modal
            modalOverlay.classList.remove('hidden');
            modalOverlay.classList.remove('modal-force-hidden'); 
            modalOverlay.classList.add('flex');

            // ajustar listeners del modal (solo si es pendiente)
            if(actionsActive) {
                modalAprobar.onclick = () => {
                    if (confirm('¬øAprobar esta reserva?')) cambiarEstado(id, 'aprobada', data.correo);
                };
                modalRechazar.onclick = () => {
                    if (confirm('¬øRechazar esta reserva?')) cambiarEstado(id, 'rechazada', data.correo);
                };
            }
        } catch (err) {
            console.error("verMas:", err);
            alert("No se pudo cargar el detalle de la reserva.");
        }
    };


    // Cambiar estado y enviar correo via Edge Function (simulado)
    window.cambiarEstado = async function(id, nuevoEstado, correo) {
        try {
            const confirmMsg = nuevoEstado === 'aprobada' ? '¬øAprobar esta reserva?' : '¬øRechazar esta reserva?';
            if (!confirm(confirmMsg)) return;

            // 1. Actualizar BD (Paso cr√≠tico para que el usuario vea el cambio)
            const { error: updErr } = await supabase
                .from('reservas')
                .update({ estado: nuevoEstado })
                .eq('id', id);

            if (updErr) {
                console.error("error update:", updErr);
                alert('Error al actualizar estado.');
                return;
            }
            alert(`Reserva ${id.substring(0, 8)}... cambiada a ${nuevoEstado}.`);

            // 2. Simulaci√≥n de llamada a Edge Function para enviar correo
            // [C√≥digo de Edge Function omitido por ser externo, pero la funci√≥n se mantien]

            // 3. Actualizar lista y cerrar modal
            await cargarReservas();
            if (currentModalId === id) {
                cerrarModal(); 
            }

        } catch (err) {
            console.error("cambiarEstado:", err);
            alert('Error cambiando estado.');
        }
    };

    // Listeners
    btnRefresh.addEventListener('click', cargarReservas);
    filterEstado.addEventListener('change', cargarReservas);

    // FIX 1: Listener para cerrar modal al hacer clic fuera del contenido
    modalOverlay.addEventListener('click', (e) => {
        if (e.target.id === 'modalOverlay') {
            cerrarModal();
        }
    });

    // Init (FIX 2: Cierre forzado al inicio)
    (() => {
        // Inicializamos forzando el estado a oculto, esto debe ejecutarse primero.
        if (modalOverlay) {
             modalOverlay.classList.add('modal-force-hidden'); 
             modalOverlay.classList.add('hidden');
             modalOverlay.classList.remove('flex');
        }
       
        // Ejecutamos las llamadas as√≠ncronas
        verificarAcceso();
        cargarReservas();
    })();

</script>

</body>
</html>