<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Reportes del Sistema ‚Äî Villa Ol√≠mpica</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap" rel="stylesheet">

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --bg-dark: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --primary: #3b82f6;
            --accent: #22d3ee;
            --text-light: #f8fafc;
            --text-muted: #94a3b8;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            background-image:
                radial-gradient(circle at 10% 20%, rgba(59, 130, 246, 0.15) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(34, 211, 238, 0.1) 0%, transparent 20%);
            color: var(--text-light);
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        .glass-panel {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 24px;
        }

        .text-glow {
            text-shadow: 0 0 20px rgba(34, 211, 238, 0.3);
        }

        .table-header-dark {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-muted);
        }

        .table-row-dark {
            background: rgba(255, 255, 255, 0.02);
        }

        .table-row-dark:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Mejor control de tablas para evitar desalineo */
        .report-table {
            width: 100%;
            table-layout: fixed; /* evita desplazamientos por contenido */
            border-collapse: collapse;
        }

        .report-table th,
        .report-table td {
            padding: 10px 12px;
            text-align: left;
            vertical-align: top;
            word-wrap: break-word;
            white-space: normal; /* para que el texto se rompa y no estire columnas */
        }

        .report-table thead th {
            font-size: 12px;
            letter-spacing: 0.02em;
        }

        .report-table tbody td {
            font-size: 13px;
            color: #cbd5e1;
        }

        /* scroll horizontal agradable */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
    </style>

</head>

<body>

    <header class="bg-[#0f172a]/80 backdrop-blur-sm border-b border-white/5 sticky top-0 z-10">
        <div class="main-container flex justify-between items-center py-4">
            <div class="flex items-center gap-4">
                <a href="menu-gestion.html"
                    class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600 to-cyan-500 flex items-center justify-center text-white font-black text-xl shadow-lg shadow-blue-500/20">
                    V
                </a>
                <div class="text-xl font-bold text-white tracking-tight hidden sm:block">
                    Reportes del Sistema
                </div>
            </div>

            <nav class="flex items-center gap-3 text-sm font-medium">
                <a href="menu-gestion.html"
                    class="px-3 py-1.5 rounded-full text-slate-400 hover:bg-white/5 transition-colors">
                    Atr√°s
                </a>
            </nav>
        </div>
    </header>


    <main class="main-container">

        <!-- T√≠tulo -->
        <div class="mb-10">
            <h1 class="text-4xl font-extrabold text-white tracking-tight text-glow">
                üìä Generaci√≥n de Reportes
            </h1>
            <p class="text-slate-400 text-sm">Seleccione un m√≥dulo y un rango de fechas.</p>
        </div>


        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

            <!-- Filtros -->
            <div class="glass-panel">

                <h2 class="text-lg font-bold mb-4">Filtros</h2>

                <label class="text-sm text-slate-300 font-semibold">1. Seleccione m√≥dulo</label>
                <select id="report-area"
                    class="w-full mt-1 mb-4 px-3 py-2 bg-slate-800 text-white rounded-lg border border-white/10 focus:ring-2 focus:ring-cyan-500">
                    <option value="">-- Seleccione --</option>

                    <option value="actividades">Actividades</option>
                    <option value="donaciones">Donaciones</option>
                    <option value="donacion_items">√çtems Donados</option>
                    <option value="inventario">Inventario General</option>
                    <option value="inventario_instalacion">Inventario por Instalaci√≥n</option>
                    <option value="inventario_movimientos">Movimientos de Inventario</option>
                    <option value="instalaciones">Instalaciones</option>
                    <option value="mantenimientos_instalacion">Mantenimientos</option>
                    <option value="reservas">Reservas</option>
                </select>

                <label class="text-sm text-slate-300 font-semibold">2. Desde</label>
                <input id="date-start" type="date"
                    class="w-full mt-1 mb-4 px-3 py-2 bg-slate-800 text-white rounded-lg border border-white/10">

                <label class="text-sm text-slate-300 font-semibold">3. Hasta</label>
                <input id="date-end" type="date"
                    class="w-full mt-1 mb-4 px-3 py-2 bg-slate-800 text-white rounded-lg border border-white/10">

                <button id="generate-preview"
                    class="w-full py-2 mt-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold">
                    Obtener Datos
                </button>

                <button id="export-pdf-btn"
                    class="w-full py-2 mt-3 bg-cyan-600 hover:bg-cyan-700 rounded-lg font-semibold">
                    Exportar PDF
                </button>

            </div>

            <!-- Vista previa -->
            <div class="glass-panel md:col-span-2">
                <h2 class="text-xl font-bold mb-3 text-white">Vista previa</h2>
                <div id="dynamic-report-content" class="table-wrapper small-muted">
                    <p class="py-10 text-center">Seleccione un m√≥dulo para mostrar datos.</p>
                </div>
            </div>
        </div>

    </main>


    <!-- Supabase logic -->
    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js";

        const SUPABASE_URL = "https://wzovzfrrgknhvcozektc.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6b3Z6ZnJyZ2tuaHZjb3pla3RjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MzYyMTAsImV4cCI6MjA3ODExMjIxMH0.zhbQqSEje7RGhZpJlUEaGZ07nuCOCamQI7S97rf-Tfo";

        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // HEADERS por tabla seg√∫n schema (solo para fallback cuando no hay datos)
        const REPORT_CONFIG = {
            actividades: {
                title: "Actividades",
                head: ["ID", "Nombre", "Fecha", "Hora", "Lugar", "Descripci√≥n", "Creado"]
            },
            donaciones: {
                title: "Donaciones",
                head: ["ID", "Fecha", "Donante", "Tipo", "Contacto", "Valor", "Notas", "Creado"]
            },
            donacion_items: {
                title: "√çtems Donados",
                head: ["ID", "Donaci√≥n", "Inventario Inst.", "Cantidad", "Obs.", "Creado"]
            },
            inventario: {
                title: "Inventario General",
                head: ["ID", "Nombre", "Cant. Actual", "Unidad", "Ubicaci√≥n", "Creado"]
            },
            inventario_instalacion: {
                title: "Inventario por Instalaci√≥n",
                head: ["ID", "Instalaci√≥n", "Nombre", "Cantidad", "Estado", "Condici√≥n", "Obs", "Actualizado", "Creado"]
            },
            inventario_movimientos: {
                title: "Movimientos Inventario",
                head: ["ID", "Inventario", "Tipo", "Cantidad", "Motivo", "Fecha"]
            },
            instalaciones: {
                title: "Instalaciones",
                head: ["ID", "Nombre", "Descripci√≥n", "Estado", "Largo", "Ancho", "Capacidad", "Tipo", "Ubicaci√≥n", "Creado"]
            },
            mantenimientos_instalacion: {
                title: "Mantenimientos",
                head: ["ID", "Instalaci√≥n", "T√≠tulo", "Descripci√≥n", "Fecha", "Estado", "Responsable", "Detalles", "Creado"]
            },
            personal: {
                title: "Personal",
                head: ["ID", "Nombre", "Apellido", "C√©dula", "Nacionalidad", "Tel√©fono", "Sexo", "Direcci√≥n", "Nivel Acad.", "Cargo", "Registro", "Activo"]
            },
            reservas: {
                title: "Reservas",
                head: ["ID", "Instalaci√≥n", "Nombre", "Tel√©fono", "Instit.", "Correo", "Inicio", "Fin", "HI", "HF", "Descripci√≥n", "Estado", "Creado"]
            },
            usuarios: {
                title: "Usuarios del Sistema",
                head: ["ID", "Nombre", "Email", "Tel√©fono", "Rol", "Creado", "Activo", "Nota"]
            }
        };

        let reportDataToExport = null;

        // Helpers
        function prettifyKey(key) {
            // Convierte snake_case o camelCase a T√≠tulo legible
            const parts = key.replace(/([a-z0-9])([A-Z])/g, '$1 $2').replace(/_/g, ' ').split(' ');
            return parts.map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(' ');
        }

        function formatValue(val) {
            if (val === null || val === undefined) return "";
            // Formatea fechas ISO simples a dd/mm/yyyy hh:mm si detecta ISO
            if (typeof val === "string" && /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}/.test(val)) {
                try {
                    const d = new Date(val);
                    if (!isNaN(d)) {
                        return d.toLocaleString();
                    }
                } catch (e) { }
            }
            if (typeof val === "object") return JSON.stringify(val);
            return String(val);
        }

        // Render table: ahora recibe headers (array de strings) y rows (array de arrays)
        function renderTable({ title, headers, body }) {
            const c = document.getElementById("dynamic-report-content");

            if (!body || body.length === 0) {
                c.innerHTML = `<p class="py-10 text-center text-cyan-300">No se encontraron registros.</p>`;
                return;
            }

            // Generar HTML de la tabla con clases que mantienen alineaci√≥n
            let html = `
                <h3 class="text-xl font-bold mb-4 text-white">${title}</h3>
                <div class="table-wrapper">
                <table class="report-table">
                    <thead class="table-header-dark">
                        <tr>
                            ${headers.map(h => `<th class="py-2 pr-4 text-left">${h}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${body.map(row => `
                            <tr class="table-row-dark">
                                ${row.map(col => `<td class="py-2 pr-4 text-slate-300">${col ?? ""}</td>`).join('')}
                            </tr>`).join('')}
                    </tbody>
                </table>
                </div>
            `;

            c.innerHTML = html;
        }

        // Read from Supabase
        document.getElementById("generate-preview").onclick = async () => {
            const table = document.getElementById("report-area").value;
            if (!table) return alert("Seleccione un m√≥dulo.");

            const start = document.getElementById("date-start").value;
            const end = document.getElementById("date-end").value;

            const cfg = REPORT_CONFIG[table] || { title: table, head: [] };
            const c = document.getElementById("dynamic-report-content");

            c.innerHTML = `<p class="py-10 text-center text-cyan-300">Cargando datos‚Ä¶</p>`;

            let q = supabase.from(table).select("*");

            // Filtros por fecha si aplica (asume campo created_at)
            if (start) q = q.gte("created_at", start);
            if (end) q = q.lte("created_at", end);

            const { data, error } = await q.order("created_at", { ascending: false });

            if (error) {
                c.innerHTML = `<p class="text-red-400 py-10 text-center">Error consultando Supabase: ${error.message}</p>`;
                return;
            }

            if (!data || data.length === 0) {
                // fallback: si no hay datos, mostramos encabezados configurados (sin IDs)
                const fallbackHeaders = (cfg.head || []).filter(h => String(h).toLowerCase() !== 'id');
                reportDataToExport = {
                    title: cfg.title,
                    headers: fallbackHeaders,
                    body: []
                };
                renderTable(reportDataToExport);
                return;
            }

            // Determinar claves del primer objeto y eliminar 'id' si existe
            const sample = { ...data[0] };
            // eliminar campos que representen id's para cumplir la petici√≥n
            for (const k of Object.keys(sample)) {
                if (k.toLowerCase() === "id" || k === "_id") {
                    delete sample[k];
                }
            }

            // keys en el orden natural del objeto (ya sin id)
            const keys = Object.keys(sample);

            // headers legibles
            const headers = keys.map(k => prettifyKey(k));

            // rows alineadas con keys
            const rows = data.map(obj => {
                // crear fila en el mismo orden de keys, omitimos id autom.
                return keys.map(k => formatValue(obj[k]));
            });

            // preparar para PDF (autotable necesita head como array de arrays)
            reportDataToExport = {
                title: cfg.title,
                headers,
                body: rows
            };

            renderTable(reportDataToExport);
        };

        // PDF
        document.getElementById("export-pdf-btn").onclick = () => {
            if (!reportDataToExport || !reportDataToExport.body) return alert("Debe generar un reporte primero.");

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(14);

            const title = reportDataToExport.title || "Reporte";
            doc.text(title, 14, 18);

            // jsPDF autotable espera head como array de arrays
            const head = [reportDataToExport.headers];
            const body = reportDataToExport.body;

            // Ajustes de estilos para evitar que columnas muy largas rompan el PDF
            doc.autoTable({
                startY: 26,
                head,
                body,
                styles: {
                    fontSize: 8,
                    overflow: 'linebreak',
                    cellWidth: 'wrap'
                },
                headStyles: {
                    fillColor: [40, 58, 90],
                    textColor: 255,
                    halign: 'left'
                },
                columnStyles: {
                    // dejar que autotable gestione los anchos; cellWidth: 'wrap' ayuda
                },
                didDrawPage: function (data) {
                    // opcional: pie de p√°gina con n√∫mero de p√°gina
                    const pageSize = doc.internal.pageSize;
                    const pageHeight = pageSize.height ? pageSize.height : pageSize.getHeight();
                    doc.setFontSize(8);
                    doc.text(`P√°gina ${doc.internal.getNumberOfPages()}`, data.settings.margin.left, pageHeight - 8);
                }
            });

            doc.save(`${title}.pdf`);
        };
    </script>

</body>

</html>
